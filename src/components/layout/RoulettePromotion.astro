---
// LuckyWheel.astro
const {
  useMock = false,
  apiUrl = 'https://app.market-dollar.com/api/v1/cupones-publicos',
  apiKey = 'market_dollar_1_mopTBt6DZr~pR*Z$'
} = Astro.props;
---

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<div
  id="mobile-backdrop"
  class="fixed inset-0 bg-black/70 z-40 hidden opacity-0 transition-opacity duration-300 md:hidden backdrop-blur-sm"
  aria-hidden="true"
>
</div>

<div
  class="fixed left-0 z-50 flex items-center font-sans perspective-1000 transition-all duration-300
          bottom-4 scale-[0.85] origin-bottom-left
          md:top-1/2 md:bottom-auto md:scale-100 md:-translate-y-1/2"
  id="promo-container"
>
  <div
    id="promo-tab"
    class="relative overflow-hidden bg-[#FFC107] h-48 w-12 rounded-r-2xl flex flex-col items-center justify-center cursor-pointer shadow-[0_4px_20px_rgba(255,193,7,0.6)] transition-all duration-500 border-r border-y border-[#001E4F]/20 z-20 hover:w-14 hover:bg-[#FFD54F] active:scale-95"
  >
    <div class="shimmer"></div>
    <span class="text-2xl mb-4 animate-wiggle filter drop-shadow-md">üé°</span>
    <span
      class="uppercase font-black text-[12px] text-[#001E4F] [writing-mode:vertical-lr] tracking-[0.35em] font-sans drop-shadow-sm transform rotate-180"
    >
      GIRA Y GANA
    </span>
  </div>

  <div
    id="promo-card"
    class="absolute left-0 flex flex-col bg-linear-to-br from-primary-800 to-primary-950 border-2 border-[#FFC107] rounded-r-3xl shadow-[20px_20px_25px_rgba(0,0,0,0.25)]
            w-75 md:w-87.5
            translate-x-[-110%] opacity-0 transition-all duration-700 ease-[cubic-bezier(0.34,1.56,0.64,1)]
            border-l-0 z-10 pointer-events-none overflow-hidden"
  >
    <button
      id="close-btn"
      class="absolute top-2 right-2 z-30 bg-white/10 hover:bg-white/20 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold transition-colors cursor-pointer shadow-sm"
    >
      ‚úï
    </button>

    <div
      class="bg-white/5 backdrop-blur-md rounded-r-[20px] w-full border border-white/10 overflow-y-auto overflow-x-hidden relative"
      style="min-height: 400px; max-height: 85vh;"
    >
      
      <!-- Loading State -->
      <div id="loading-view" class="flex flex-col items-center justify-center w-full px-4 py-8" style="min-height: 350px;">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-[#FFC107] border-t-transparent"></div>
      </div>

      <!-- Error State -->
      <div id="error-view" class="hidden flex-col items-center justify-center w-full px-4 py-8" style="min-height: 350px;">
        <div class="text-4xl mb-3">‚ö†Ô∏è</div>
        <p class="text-white font-bold text-lg mb-2">Error al cargar</p>
        <p class="text-white/70 text-sm mb-4" id="error-message">No se pudieron cargar los cupones</p>
        <button id="retry-btn" class="bg-[#FFC107] text-[#001E4F] px-6 py-2 rounded-full font-bold hover:bg-[#FFD54F] transition-colors">
          Reintentar
        </button>
      </div>

      <!-- No Cupones Available -->
      <div id="no-cupones-view" class="hidden flex-col items-center justify-center w-full px-4 py-8" style="min-height: 350px;">
        <div class="text-4xl mb-3">üòî</div>
        <p class="text-white font-bold text-lg mb-2">Sin cupones disponibles</p>
        <p class="text-white/70 text-sm">Vuelve pronto para nuevas promociones</p>
      </div>

      <!-- Wheel View -->
      <div id="wheel-view" class="hidden w-full px-4 py-6">
        <div class="flex flex-col items-center text-center w-full">
          <h3 class="text-[#FFC107] font-black text-xl uppercase italic drop-shadow-md mb-3">
            ¬°Prueba tu suerte!
          </h3>
          
          <div class="relative mb-4" style="width: 224px; height: 224px;">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1 z-20 w-8 h-10 bg-red-600 clip-triangle shadow-lg"></div>
            <div class="absolute inset-0 rounded-full border-4 border-[#FFC107] z-10 pointer-events-none shadow-[inset_0_0_20px_rgba(0,0,0,0.5)]"></div>
            <canvas id="wheelCanvas" width="500" height="500" style="width: 224px; height: 224px; display: block;"></canvas>
          </div>

          <button id="spinBtn" class="bg-[#FFC107] text-[#001E4F] px-8 py-2.5 rounded-full font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-transform shadow-[0_0_15px_rgba(255,193,7,0.4)] mb-3">
            ¬°Girar Ahora!
          </button>
          
          <!-- Mensaje de cooldown -->
          <div id="cooldown-message" class="hidden mb-2">
            <p class="text-gray-300 text-xs mb-1">Tu c√≥digo fue: <span id="saved-code-display" class="text-[#FFC107] font-mono font-bold">--</span></p>
            <p class="text-gray-400 text-[10px]">Vuelve a girar en: <span id="cooldown-timer" class="text-[#FFC107] font-mono">--</span></p>
          </div>

          <!-- Info del cup√≥n -->
          <div class="mb-2">
            <p class="text-white/50 text-[10px]">
              Usos disponibles: <span id="usos-disponibles" class="text-[#FFC107] font-bold">--</span>
            </p>
          </div>
        </div>
      </div>

      <!-- Result View -->
      <div id="result-view" class="hidden w-full px-4 py-6">
        <div class="flex flex-col items-center text-center w-full">
          <div class="text-5xl mb-3 animate-bounce">üéâ</div>
          <h3 class="text-white font-bold text-2xl mb-2">¬°Felicidades!</h3>
          <div id="prize-text" class="text-[#FFC107] font-black text-xl uppercase tracking-wide mb-4">CUP√ìN GANADO</div>

          <div class="w-full my-4 p-4 bg-white/10 border-2 border-dashed border-[#FFC107] rounded-lg relative overflow-hidden">
              <span class="text-[10px] text-gray-400 uppercase block mb-2">Tu c√≥digo promocional:</span>
              <div id="coupon-code" class="text-white font-mono text-2xl font-bold tracking-widest break-all mb-3">--</div>
              
              <!-- Descripci√≥n del descuento -->
              <div class="pt-3 border-t border-white/20">
                <p class="text-white/70 text-sm leading-relaxed" id="coupon-description">--</p>
              </div>
          </div>

          <div class="flex items-center gap-2 mb-6 bg-white/5 px-4 py-2 rounded-lg">
              <span class="text-[11px] text-gray-400 font-bold uppercase">Expira:</span>
              <div id="expiration-date" class="text-[#FFC107] font-mono font-bold text-sm">--</div>
          </div>

          <button id="claimBtn" class="w-full bg-[#FFC107] text-[#001E4F] py-3 px-4 rounded-xl font-black text-sm uppercase hover:bg-yellow-300 transition-all shadow-lg flex items-center justify-center gap-2">
            <span id="claim-text">Copiar y Reclamar</span>
            <svg id="copy-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
            </svg>
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
  .clip-triangle { clip-path: polygon(100% 0, 0 0, 50% 100%); }
  
  /* Animaci√≥n Shimmer */
  .shimmer {
    position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
    background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.6), transparent);
    transform: skewX(-20deg); animation: shimmer-tab 3s infinite;
  }
  @keyframes shimmer-tab { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
  
  /* Wiggle Icono */
  @keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
  .animate-wiggle { animation: wiggle 0.5s ease-in-out infinite alternate; }
  
  /* Giro Lento Idle */
  @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .wheel-idle { animation: spin-slow 20s linear infinite; }

  /* ESTADOS JS */
  .state-open-card { translate: 0 !important; opacity: 1 !important; pointer-events: auto !important; }
  .state-hide-tab { opacity: 0 !important; pointer-events: none !important; }
  
  /* Mobile Overlay */
  .backdrop-active { display: block !important; opacity: 1 !important; }
  @media (max-width: 768px) {
    .mobile-popup-active { position: fixed !important; inset: 0; display: flex !important; justify-content: center; align-items: center; z-index: 50 !important; }
    .mobile-popup-active #promo-card { position: relative !important; transform: none !important; translate: 0 0 !important; opacity: 1 !important; pointer-events: auto !important; max-width: 90vw; animation: entry-effect 0.5s ease-out forwards; }
  }
  @keyframes entry-effect { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }

  /* Custom scrollbar */
  #promo-card > div::-webkit-scrollbar {
    width: 6px;
  }
  #promo-card > div::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
  }
  #promo-card > div::-webkit-scrollbar-thumb {
    background: rgba(255, 193, 7, 0.5);
    border-radius: 10px;
  }
  #promo-card > div::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 193, 7, 0.7);
  }

  /* Forzar estilos limpios en canvas */
  #wheelCanvas {
    display: block !important;
    margin: 0 auto !important;
    padding: 0 !important;
    border: none !important;
    outline: none !important;
    background: transparent !important;
  }

  /* Prevenir cualquier overflow o elemento extra */
  #wheel-view, #result-view {
    box-sizing: border-box;
  }

  #wheel-view > div,
  #result-view > div {
    box-sizing: border-box;
  }

  /* Eliminar sombras extra√±as que puedan causar el efecto */
  .filter {
    filter: drop-shadow(0 25px 25px rgb(0 0 0 / 0.15));
  }
</style>


<script define:vars={{ apiUrl, apiKey, useMock }}>
  (function() {
    'use strict';
    
    const COOLDOWN_TIME = 24 * 60 * 60 * 1000;
    const API_URL = apiUrl;
    const API_KEY = apiKey;
    const USE_MOCK = useMock;
    const STORAGE_KEYS = {
      LAST_SPIN: "last_spin_timestamp",
      COUPON_CODE: "user_coupon_code",
      COUPON_DATA: "user_coupon_data",
      AUTH_TOKEN: "auth_token"
    };

    const elements = {
      loadingView: document.getElementById('loading-view'),
      errorView: document.getElementById('error-view'),
      noCuponesView: document.getElementById('no-cupones-view'),
      wheelView: document.getElementById('wheel-view'),
      resultView: document.getElementById('result-view'),
      canvas: document.getElementById('wheelCanvas'),
      spinBtn: document.getElementById('spinBtn'),
      retryBtn: document.getElementById('retry-btn'),
      prizeText: document.getElementById('prize-text'),
      couponCode: document.getElementById('coupon-code'),
      couponDescription: document.getElementById('coupon-description'),
      expirationDate: document.getElementById('expiration-date'),
      usosDisponibles: document.getElementById('usos-disponibles'),
      errorMessage: document.getElementById('error-message'),
      cooldownMessage: document.getElementById('cooldown-message'),
      cooldownTimer: document.getElementById('cooldown-timer'),
      savedCodeDisplay: document.getElementById('saved-code-display'),
      claimBtn: document.getElementById('claimBtn'),
      claimText: document.getElementById('claim-text'),
      container: document.querySelector("#promo-container"),
      card: document.querySelector("#promo-card"),
      backdrop: document.querySelector("#mobile-backdrop"),
      tab: document.querySelector("#promo-tab"),
      closeBtn: document.querySelector("#close-btn")
    };

    const ctx = elements.canvas?.getContext('2d');

    const appState = {
      cupones: [],
      currentCoupon: null,
      autoHideTimer: null,
      cooldownTimer: null,
      hasInteracted: false,
      isSpinning: false,
      isInitialized: false,
      currentRotation: 0,
      prizes: [],
      animationFrame: null
    };

    function canUserSpin() {
      const lastSpin = localStorage.getItem(STORAGE_KEYS.LAST_SPIN);
      if (!lastSpin) return true;
      const now = Date.now();
      const diff = now - parseInt(lastSpin);
      return diff >= COOLDOWN_TIME;
    }

    function getTimeRemaining() {
      const lastSpin = localStorage.getItem(STORAGE_KEYS.LAST_SPIN);
      if (!lastSpin) return null;
      const diff = COOLDOWN_TIME - (Date.now() - parseInt(lastSpin));
      if (diff <= 0) return null;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}h ${minutes}m`;
    }

    function updateCooldownDisplay() {
      const timeLeft = getTimeRemaining();
      if (timeLeft && elements.cooldownTimer) {
        elements.cooldownTimer.textContent = timeLeft;
      } else if (!timeLeft) {
        if (appState.cooldownTimer) {
          clearInterval(appState.cooldownTimer);
          appState.cooldownTimer = null;
        }
        fetchCupones();
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function formatDescuento(descripcion, detalles) {
      if (!descripcion) return "Descuento especial";
      const { tipo_descuento, valor, tipo_cambio } = descripcion;
      if (tipo_descuento === "valor_fijo") {
        if (detalles?.valores_especificos) {
          const { compra, venta } = detalles.valores_especificos;
          if (compra === venta) {
            return `Descuento de S/ ${compra.toFixed(4)} en compra y venta`;
          } else {
            return `Descuento de S/ ${compra.toFixed(4)} (compra) y S/ ${venta.toFixed(4)} (venta)`;
          }
        }
        if (tipo_cambio === "ambos") {
          return `Descuento de S/ ${valor.toFixed(4)} en compra y venta`;
        } else {
          return `Descuento de S/ ${valor.toFixed(4)} en tipo de cambio ${tipo_cambio}`;
        }
      } else if (tipo_descuento === "porcentaje") {
        if (tipo_cambio === "ambos") {
          return `${valor}% de descuento en compra y venta`;
        } else {
          return `${valor}% de descuento en tipo de cambio ${tipo_cambio}`;
        }
      }
      return "Descuento especial";
    }

    async function fetchCupones() {
      try {
        showView('loading');
        let data;
        if (USE_MOCK) {
          const mockResponse = await fetch('/mock/cupones.mock.json');
          if (!mockResponse.ok) throw new Error('No se pudo cargar el mock local');
          data = await mockResponse.json();
        } else {
          const response = await fetch(API_URL, { headers: { 'x-api-key': API_KEY } });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          data = await response.json();
        }
        if (!data.success || !data.data || data.data.length === 0) {
          showView('no-cupones');
          return;
        }
        appState.cupones = data.data.filter(cupon =>
          cupon.detalles.activo &&
          cupon.detalles.visibilidad === "publico" &&
          (cupon.disponibilidad.usos_disponibles === null || cupon.disponibilidad.usos_disponibles > 0)
        );
        if (appState.cupones.length === 0) {
          showView('no-cupones');
          return;
        }
        appState.currentCoupon = appState.cupones[0];
        appState.prizes = [
          appState.currentCoupon.codigo, "¬°Intenta de nuevo!",
          appState.currentCoupon.codigo, "Casi...",
          appState.currentCoupon.codigo, "¬°Sigue intentando!"
        ];
        updateCouponInfo();
        drawWheel();
        startIdleAnimation();
        checkCooldownStatus();
        showView('wheel');
      } catch (error) {
        console.error('Error fetching cupones:', error);
        elements.errorMessage.textContent = error.message || 'Error al cargar los cupones';
        showView('error');
      }
    }

    function updateCouponInfo() {
      if (!appState.currentCoupon) return;
      const { disponibilidad } = appState.currentCoupon;
      if (elements.usosDisponibles) {
        if (disponibilidad.usos_disponibles === null) {
          elements.usosDisponibles.textContent = "Ilimitado";
        } else {
          elements.usosDisponibles.textContent = `${disponibilidad.usos_disponibles}/${disponibilidad.limite_usos}`;
        }
      }
    }

    function checkCooldownStatus() {
      if (!canUserSpin()) {
        elements.spinBtn.disabled = true;
        elements.spinBtn.style.opacity = "0.5";
        elements.spinBtn.textContent = "Ya giraste hoy";
        elements.cooldownMessage.classList.remove('hidden');
        if (appState.cooldownTimer) clearInterval(appState.cooldownTimer);
        appState.cooldownTimer = setInterval(updateCooldownDisplay, 1000);
        updateCooldownDisplay();
        const savedCoupon = localStorage.getItem(STORAGE_KEYS.COUPON_CODE);
        if (savedCoupon && elements.savedCodeDisplay) {
          elements.savedCodeDisplay.textContent = savedCoupon;
        }
      } else {
        elements.spinBtn.disabled = false;
        elements.spinBtn.style.opacity = "1";
        elements.spinBtn.textContent = "¬°Girar Ahora!";
        elements.cooldownMessage.classList.add('hidden');
      }
    }

    function showView(viewName) {
      const views = [elements.loadingView, elements.errorView, elements.noCuponesView, elements.wheelView, elements.resultView];
      views.forEach(view => { if (view) { view.classList.add('hidden'); view.style.display = 'none'; } });
      let targetView = null;
      switch(viewName) {
        case 'loading': targetView = elements.loadingView; break;
        case 'error': targetView = elements.errorView; break;
        case 'no-cupones': targetView = elements.noCuponesView; break;
        case 'wheel': targetView = elements.wheelView; break;
        case 'result': targetView = elements.resultView; break;
      }
      if (targetView) {
        targetView.classList.remove('hidden');
        targetView.style.display = 'block';
      }
    }

    function openPromo() {
      if (appState.autoHideTimer) { clearTimeout(appState.autoHideTimer); appState.autoHideTimer = null; }
      if (window.innerWidth < 768) { 
        elements.container.classList.add("mobile-popup-active"); 
        elements.backdrop.classList.add("backdrop-active"); 
      } else { 
        elements.card.classList.add("state-open-card");
      }
      elements.tab.classList.add("state-hide-tab");
    }

    function closePromo() {
      elements.container.classList.remove("mobile-popup-active"); 
      elements.backdrop.classList.remove("backdrop-active");
      elements.card.classList.remove("state-open-card"); 
      elements.tab.classList.remove("state-hide-tab"); 
    }

    const colors = ["#FFC107", "#001E4F"]; 
    const textColors = ["#001E4F", "#FFC107"];

    function drawWheel() {
      if (!appState.prizes.length || !ctx) return;
      const numSegments = appState.prizes.length;
      const arcSize = (2 * Math.PI) / numSegments;
      const radius = elements.canvas.width / 2;
      ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
      for (let i = 0; i < numSegments; i++) {
        const angle = i * arcSize;
        ctx.beginPath();
        ctx.fillStyle = colors[i % 2];
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, angle, angle + arcSize);
        ctx.fill();
        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(angle + arcSize / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = textColors[i % 2];
        ctx.font = "bold 24px sans-serif";
        let text = appState.prizes[i];
        if (text.length > 12) text = text.substring(0, 10) + "...";
        ctx.fillText(text, radius - 20, 10);
        ctx.restore();
      }
    }

    function startIdleAnimation() {
      stopIdleAnimation();
      appState.currentRotation = 0;
      elements.canvas.style.transition = 'none';
      elements.canvas.style.transform = 'rotate(0deg)';
      requestAnimationFrame(() => { elements.canvas.classList.add('wheel-idle'); });
    }

    function stopIdleAnimation() {
      elements.canvas.classList.remove('wheel-idle');
      const style = window.getComputedStyle(elements.canvas);
      const matrix = new DOMMatrix(style.transform);
      const currentAngle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
      elements.canvas.style.transition = 'none';
      elements.canvas.style.transform = `rotate(${currentAngle}deg)`;
      appState.currentRotation = currentAngle;
      void elements.canvas.offsetWidth;
    }

    const tickAudio = new Audio("");
    function playTickSound() {
      tickAudio.pause();
      tickAudio.currentTime = 0;
      tickAudio.volume = 0.3;
      tickAudio.play().catch(() => {});
    }

    function spinWheel() {
      if (!canUserSpin() || appState.isSpinning || !appState.currentCoupon) return;
      appState.hasInteracted = true;
      appState.isSpinning = true;
      elements.spinBtn.disabled = true;
      elements.spinBtn.style.opacity = "0.5";
      if (appState.autoHideTimer) { clearTimeout(appState.autoHideTimer); appState.autoHideTimer = null; }
      localStorage.setItem(STORAGE_KEYS.LAST_SPIN, Date.now().toString());
      stopIdleAnimation();
      const winningIndices = [0, 2, 4];
      const winningIndex = winningIndices[Math.floor(Math.random() * winningIndices.length)];
      const segmentAngle = 360 / appState.prizes.length;
      elements.canvas.style.transition = 'transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)';
      requestAnimationFrame(() => {
        const stopOffset = 360 - (winningIndex * segmentAngle) - (segmentAngle / 2);
        const targetRotation = appState.currentRotation + (8 * 360) + stopOffset;
        elements.canvas.style.transform = `rotate(${targetRotation}deg)`;
        let lastAngle = appState.currentRotation % 360;
        function monitor() {
          if (!appState.isSpinning) return;
          const matrix = new DOMMatrix(window.getComputedStyle(elements.canvas).transform);
          let angle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
          if (angle < 0) angle += 360;
          if (Math.abs(angle - lastAngle) > (360 / appState.prizes.length)) {
            playTickSound();
            lastAngle = angle;
          }
          appState.animationFrame = requestAnimationFrame(monitor);
        }
        appState.animationFrame = requestAnimationFrame(monitor);
      });
      setTimeout(() => {
        if (appState.animationFrame) {
          cancelAnimationFrame(appState.animationFrame);
          appState.animationFrame = null;
        }
        showWinningResult();
      }, 4000);
    }

    function showWinningResult() {
      localStorage.setItem(STORAGE_KEYS.COUPON_CODE, appState.currentCoupon.codigo);
      localStorage.setItem(STORAGE_KEYS.COUPON_DATA, JSON.stringify(appState.currentCoupon));
      elements.prizeText.textContent = "¬°Cup√≥n Ganado!";
      elements.couponCode.textContent = appState.currentCoupon.codigo;
      elements.couponDescription.textContent = formatDescuento(appState.currentCoupon.descripcion, appState.currentCoupon.detalles);
      elements.expirationDate.textContent = formatDate(appState.currentCoupon.disponibilidad.fecha_expiracion);
      showView('result');
      new Audio("https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3").play().catch(() => {});
      if (typeof confetti === 'function') {
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });
      }
      appState.isSpinning = false;
    }

    function setupEventListeners() {
      if (appState.isInitialized) return;
      elements.container.addEventListener("mouseenter", () => { if (!appState.isSpinning) { openPromo(); appState.hasInteracted = true; } });
      elements.container.addEventListener("mouseleave", () => { if (!appState.isSpinning && !appState.hasInteracted) { appState.autoHideTimer = setTimeout(closePromo, 5000); } });
      elements.tab.addEventListener("click", (e) => { e.stopPropagation(); appState.hasInteracted = true; openPromo(); });
      elements.closeBtn.addEventListener("click", (e) => { e.stopPropagation(); appState.hasInteracted = true; closePromo(); });
      elements.spinBtn.addEventListener('click', spinWheel);
      elements.retryBtn.addEventListener('click', fetchCupones);
      elements.claimBtn.addEventListener('click', () => {
        const code = elements.couponCode.innerText;
        navigator.clipboard.writeText(code).then(() => {
          elements.claimText.innerText = "¬°Copiado!";
          elements.claimBtn.style.backgroundColor = "#4ADE80";
          setTimeout(() => {
            const isLoggedIn = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN) !== null;
            if (isLoggedIn) {
              window.location.href = "https://app.market-dollar.com/dashboard";
            } else {
              window.location.href = "https://app.market-dollar.com/register";
            }
          }, 1000);
        });
      });
      appState.isInitialized = true;
    }

    function initAutoShow() {
      setTimeout(() => {
        const isDesktop = window.innerWidth >= 768;
        if (!appState.hasInteracted && isDesktop) {
          openPromo();
          appState.autoHideTimer = setTimeout(() => {
            if (!appState.hasInteracted && !appState.isSpinning) closePromo();
          }, 8000);
        }
      }, 2000);
    }

    function cleanup() {
      if (appState.autoHideTimer) clearTimeout(appState.autoHideTimer);
      if (appState.cooldownTimer) clearInterval(appState.cooldownTimer);
      if (appState.animationFrame) cancelAnimationFrame(appState.animationFrame);
    }

    window.addEventListener('beforeunload', cleanup);

    function init() {
      setupEventListeners();
      fetchCupones();
      initAutoShow();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
  })();
</script>