---
import Button from '@components/ui/Button.astro';
import Icon from '@components/ui/Icon.astro';
import { type NavItem, APP_URLS, getClientTabs } from '@utils/navigation';

interface Props {
  options: NavItem[];
  pathname?: string;
}

const { options, pathname = '/' } = Astro.props;

// Usar función centralizada para tabs
const clientTabs = getClientTabs(pathname);

const contentButtons = [
  // { text: 'Registrarse Ahora', href: APP_URLS.register, variant: 'primary', iconName: 'user'},
  // { text: 'Iniciar Sesión', href: APP_URLS.login, variant: 'outline', iconName: 'login'},
  { text: 'Acceder Ahora', href: APP_URLS.login, variant: 'primary', iconName: 'login', target: '_self' },
  { text: 'Contactar Soporte', href: APP_URLS.whatsappSupport, variant: 'whatsapp', iconName: 'whatsapp', target: '_blank' }
] as const;
---

<button 
  type="button"
  id="mobile-menu-trigger" 
  class="p-2 text-primary-500 hover:text-neutral-100 bg-neutral-100 xl:hidden hover:bg-primary-500 rounded-lg transition-colors active:scale-95"
  aria-haspopup="true"
  aria-expanded="false"
  aria-controls="mobile-sidebar"
  aria-label="Abrir menú de navegación"
>
  <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 6h16M4 12h16m-7 6h7" />
  </svg>
</button>

<aside 
  id="mobile-sidebar" 
  class="fixed inset-0 z-100 invisible pointer-events-none"
  aria-labelledby="mobile-menu-trigger"
>
  <div id="mobile-overlay" class="absolute inset-0 bg-black/40 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>

  <nav 
    class="absolute right-0 top-0 h-full w-[80%] max-w-sm bg-white shadow-2xl translate-x-full transition-transform duration-300 ease-in-out flex flex-col"
  >
    <div class="bg-primary-600 p-6 flex items-center justify-between border-b border-neutral-100">
      <a href="/">
        <img 
          class="w-35 md:w-40" 
          src="/logo.png" 
          width="140" 
          height="35"
          alt="Logo Horizontal de El Gordito"
        >
      </a>
      <button id="mobile-menu-close" class="p-2 text-primary-600 hover:text-neutral-100 bg-neutral-100 hover:bg-primary-500 border-2 border-neutral-200 rounded-full transition-all duration-300" aria-label="Cerrar menú">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Tipo de Cliente -->
    <div class="px-4 py-4 border-b border-neutral-200">
      <h3 class="text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-3">Tipo de cliente</h3>
      <div class="flex gap-2">
        {clientTabs.map((tab) => (
          <a 
            href={tab.href}
            class:list={[
              "flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200",
              tab.active 
                ? "bg-primary-600 text-white shadow-md" 
                : "bg-neutral-100 text-neutral-600 hover:bg-neutral-200"
            ]}
            aria-current={tab.active ? 'page' : undefined}
          >
            <Icon name={tab.icon} class="size-4" />
            <span>{tab.name}</span>
          </a>
        ))}
      </div>
    </div>

    <ul class="flex-1 px-4 py-6 overflow-y-auto space-y-2">
  {options.map((item) => (
    <li>
      {item.children && item.children.length > 0 ? (
        <!-- ITEM CON SUBMENÚ -->
        <>
          <div
            class="
              flex items-center justify-between
              px-4 py-3
              rounded-xl
              hover:bg-primary-600 hover:text-white
              transition-all
            "
          >
            <!-- Link navegable -->
            <a
              href={item.href}
              class="flex items-center gap-4 text-btn font-medium text-neutral-700 flex-1"
            >
              <span class="text-primary-600 border-2 border-primary-600 rounded-full p-2 bg-white">
                <Icon name={item.iconName} aria-hidden="true" />
              </span>
              {item.name}
            </a>

            <!-- Botón accordion -->
            <button
              type="button"
              data-accordion-toggle
              aria-label={`Expandir ${item.name}`}
              class="p-2 text-neutral-600 hover:text-white"
            >
              <svg
                class="w-4 h-4 transition-transform"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path d="m6 9 6 6 6-6" />
              </svg>
            </button>
          </div>

          <!-- Submenu -->
          <ul class="mt-2 ml-10 space-y-1 hidden">
            {item.children.map((child) => (
              <li>
                <a
                  href={child.href}
                  class="
                    flex items-center gap-1 px-4 py-2
                    text-sm
                    text-neutral-600
                    hover:text-primary-600 hover:bg-neutral-100
                    rounded-lg
                    transition-colors
                  "
                >
                  <Icon name="check-circle" class='text-primary-600' />
                  {child.name}
                </a>
              </li>
            ))}
          </ul>
        </>
      ) : (
        <!-- ITEM NORMAL -->
        <a
          href={item.href}
          class="
            flex items-center gap-4
            px-4 py-3
            text-btn font-medium
            text-neutral-600
            hover:text-white hover:bg-primary-600
            rounded-xl
            transition-all
          "
        >
          <span class="text-primary-600 border-2 border-primary-600 rounded-full p-2 bg-white">
            <Icon name={item.iconName} aria-hidden="true" />
          </span>
          {item.name}
        </a>
      )}
    </li>
  ))}
</ul>



    <div class="p-6 border-t border-neutral-100 bg-neutral-50 flex flex-col gap-4">
      {contentButtons.map(btn => (
        <Button href={btn.href} variant={btn.variant} class='gap-2' target={btn.target}>
          <Icon name={btn.iconName}/>
          {btn.text}
        </Button>
      ))}
    </div>
  </nav>
</aside>

<style>
  /* Importante: Cambia la ruta por la ubicación real de tu CSS global */
  @reference "../../styles/global.css";

  /* Control de estados mediante clases */
  #mobile-sidebar.is-open {
    @apply visible pointer-events-auto;
  }
  #mobile-sidebar.is-open #mobile-overlay {
    @apply opacity-100;
  }
  #mobile-sidebar.is-open nav {
    @apply translate-x-0;
  }

  li.open > ul {
    display: block;
  }

  li.open button svg {
    transform: rotate(180deg);
  }

</style>

<script>
  const trigger = document.getElementById('mobile-menu-trigger');
  const closeBtn = document.getElementById('mobile-menu-close');
  const sidebar = document.getElementById('mobile-sidebar');
  const overlay = document.getElementById('mobile-overlay');

  function openMenu() {
    sidebar?.classList.add('is-open');
    trigger?.setAttribute('aria-expanded', 'true');
    document.body.style.overflow = 'hidden';
    closeBtn?.focus();
  }

  function closeMenu({ restoreFocus = true } = {}) {
    sidebar?.classList.remove('is-open');
    trigger?.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';
    if (restoreFocus) trigger?.focus();
  }

  trigger?.addEventListener('click', openMenu);
  closeBtn?.addEventListener('click', () => closeMenu());
  overlay?.addEventListener('click', () => closeMenu());

  document.querySelectorAll('[data-accordion-toggle]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.preventDefault();
      e.stopPropagation();
      btn.closest('li')?.classList.toggle('open');
    });
  });

  sidebar?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => closeMenu({ restoreFocus: false }));
  });
</script>