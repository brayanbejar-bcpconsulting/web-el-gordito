---
import Icon from '@/components/ui/Icon.astro';
import Button from '@/components/ui/Button.astro';
import { APP_URLS } from '@/utils/navigation';
---

<div id="calc-container" class="w-full max-w-md mx-auto">
  <div class="flex bg-primary-500 p-1 rounded-xl mb-6 relative border border-white/10 shadow-inner">
    <button id="mode-buy" data-mode="buy" class="mode-btn flex-1 py-2.5 px-4 rounded-lg text-sm font-bold transition-all z-10">
      Quiero Vender 
      <span class="block text-xs font-bold opacity-80" id="display-compra">
        <span class="inline-block w-8 h-3 bg-white/20 animate-pulse rounded"></span>
      </span>
    </button>
    <button id="mode-sell" data-mode="sell" class="mode-btn flex-1 py-2.5 px-4 rounded-lg text-sm font-bold transition-all z-10">
      Quiero Comprar 
      <span class="block text-xs font-bold opacity-80" id="display-venta">
        <span class="inline-block w-8 h-3 bg-white/20 animate-pulse rounded"></span>
      </span>
    </button>
  </div>

  <div class="space-y-3 relative">
    <section class="p-4 bg-neutral-50 rounded-2xl border-2 border-transparent focus-within:border-secondary-400 transition-all shadow-sm">
      <label for="input-envio" class="text-xs font-bold text-neutral-400 uppercase tracking-wider">Tú Envías</label>
      <div class="flex justify-between items-center mt-1">
        <span class="flex items-center gap-3 text-xl font-extrabold text-primary-950">
          <Icon name='flag-usa' class="size-6" id="icon-envio" />
          <span id="text-envio">Dólares</span>
        </span>
        <input type="number" id="input-envio" step="any" placeholder="0.00" class="no-spinner w-1/2 text-right text-2xl font-black bg-transparent outline-none text-neutral-700" />
      </div>
    </section>

    <button id="btn-switch" aria-label="Invertir monedas" class="absolute left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 bg-secondary-400 p-2.5 rounded-full shadow-lg border-4 border-white hover:scale-110 transition-all active:rotate-180 duration-500">
      <Icon name="refresh" class="size-5 text-primary-950" />
    </button>

    <section class="p-4 bg-neutral-100 rounded-2xl border-2 border-transparent focus-within:border-success-500 transition-all shadow-sm">
      <label for="input-recibo" class="text-xs font-bold text-neutral-400 uppercase tracking-wider">Tú Recibes</label>
      <div class="flex justify-between items-center mt-1">
        <span class="flex items-center gap-3 text-xl font-extrabold text-primary-950">
          <Icon name='flag-peru' class="size-6" id="icon-recibo" />
          <span id="text-recibo">Soles</span>
        </span>
        <input type="number" id="input-recibo" step="any" placeholder="0.00" class="no-spinner w-1/2 text-right text-2xl font-black bg-transparent outline-none text-success-600" />
      </div>
    </section>
  </div>

  <Button href={APP_URLS.login} variant="secondary" class="mt-6 w-full font-bold py-4 shadow-lg active:scale-[0.98] transition-transform">
    Cambiar ahora
  </Button>
</div>

<style>
  .no-spinner::-webkit-inner-spin-button, .no-spinner::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  .no-spinner { -moz-appearance: textfield; }

  /* Clase de activo solicitada */
  .mode-btn.active {
    background-color: white;
    color: var(--color-primary-500);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  }
  .mode-btn:not(.active) {
    color: white;
  }
</style>

<script>
  interface ExchangeRates { compra: number; venta: number; }
  const FALLBACK: ExchangeRates = { compra: 3.354, venta: 3.365 };
  
  let rates = { ...FALLBACK };
  let isSendUsd = true; 

  const inputEnvio = document.getElementById('input-envio') as HTMLInputElement;
  const inputRecibo = document.getElementById('input-recibo') as HTMLInputElement;
  const iconEnvio = document.getElementById('icon-envio') as HTMLElement;
  const iconRecibo = document.getElementById('icon-recibo') as HTMLElement;
  const textEnvio = document.getElementById('text-envio');
  const textRecibo = document.getElementById('text-recibo');
  const btnBuy = document.getElementById('mode-buy');
  const btnSell = document.getElementById('mode-sell');

  // Sincronización Maestra
  function syncState(sendUsd: boolean) {
    isSendUsd = sendUsd;

    // 1. Actualizar Buttons Superiores (UI Activa)
    if (isSendUsd) {
      btnBuy?.classList.add('active');
      btnSell?.classList.remove('active');
    } else {
      btnSell?.classList.add('active');
      btnBuy?.classList.remove('active');
    }

    // 2. Actualizar Textos e Iconos de Inputs
    if (textEnvio && textRecibo) {
      textEnvio.textContent = isSendUsd ? 'Dólares' : 'Soles';
      textRecibo.textContent = isSendUsd ? 'Soles' : 'Dólares';
    }

    const nameEnvio = isSendUsd ? 'flag-usa' : 'flag-peru';
    const nameRecibo = isSendUsd ? 'flag-peru' : 'flag-usa';
    updateIcon(iconEnvio, nameEnvio);
    updateIcon(iconRecibo, nameRecibo);

    calcular('envio');
  }

  function updateIcon(el: HTMLElement | null, name: string) {
    if (!el) return;
    const useTag = el.querySelector('use');
    if (useTag) {
      const currentHref = useTag.getAttribute('href') || '';
      const basePath = currentHref.split('#')[0];
      useTag.setAttribute('href', `${basePath}#${name}`);
    }
  }

  function calcular(source: 'envio' | 'recibo') {
    if (!inputEnvio || !inputRecibo) return;
    
    // Tasa: Si mando USD uso COMPRA. Si mando PEN uso VENTA.
    const tasa = isSendUsd ? rates.compra : rates.venta;

    if (source === 'envio') {
      const monto = parseFloat(inputEnvio.value) || 0;
      const res = isSendUsd ? monto * tasa : monto / tasa;
      inputRecibo.value = monto > 0 ? res.toFixed(2) : "";
    } else {
      const monto = parseFloat(inputRecibo.value) || 0;
      const res = isSendUsd ? monto / tasa : monto * tasa;
      inputEnvio.value = monto > 0 ? res.toFixed(2) : "";
    }
  }

  // Eventos de Inputs
  inputEnvio?.addEventListener('input', () => calcular('envio'));
  inputRecibo?.addEventListener('input', () => calcular('recibo'));

  // Evento Botones Superiores (Modo)
  btnBuy?.addEventListener('click', () => syncState(true));
  btnSell?.addEventListener('click', () => syncState(false));

  // Evento Botón Switch Central (Invertir)
  document.getElementById('btn-switch')?.addEventListener('click', () => {
    syncState(!isSendUsd);
  });

  async function init() {
    try {
      const res = await fetch('/api/exchange-rate');
      if(res.ok) rates = await res.json();
    } catch {
      console.warn("Usando fallbacks");
    }
    
    if (document.getElementById('display-compra')) 
      document.getElementById('display-compra')!.textContent = `S/ ${rates.compra.toFixed(3)}`;
    if (document.getElementById('display-venta')) 
      document.getElementById('display-venta')!.textContent = `S/ ${rates.venta.toFixed(3)}`;
    
    inputEnvio.value = "1000";
    syncState(true); // Iniciar como "Vender Dólares" (Quiero Vender activo)
  }

  init();
</script>